<?xml version="1.0"?>

<!--
============================================================
                Dependency updater
                   Version 2.3
           Jeff Turner <jefft@apache.org>

This Ant script provides "functions" to check if
dependencies are present, and take appropriate action if
they are not. "Appropriate action" may be:

- Print an error message
- Build the project, if local
- Retrieve the jar dependency via HTTP GET

To use it, type 'ant -f depchecker.xml'
============================================================-->

<!--
-->

<project name="dependencies" default="main" basedir=".">
    <!-- The target to call if ${proj.target} isn't specified -->
    <property name="default.target" value="dist.lite"/>
    <property name="nl" value="${line.separator}"/>

    <target name="main" depends="usage"/>
    <target name="usage">
        <echo><![CDATA[
            =======================================================
            This is Excalibur's dependency updater script.
            Which has been called incorrectly :)

            To use it, you must call the checkRequiredFile or
            checkRequiredClass targets from your Ant script.

            For example:

            <ant antfile="depchecker.xml" target="checkRequiredFile">
                <property name="name" value="excalibur-concurrent.jar"/>
                <property name="path" value="$${excalibur-concurrent.jar}"/>
                <property name="proj.home" value="../concurrent"/>
                <property name="proj.target" value="dist.lite"/>
            </ant>

            That will check if $${excalibur-concurrent.jar} points to a jar, and
            if it doesn't, build the $${proj.home} project in order to generate
            the jar

            or:

            <ant antfile="depchecker.xml" target="checkRequiredFile">
                <property name="name" value="commons-io.jar"/>
                <property name="path" value="$${lib.repo}/commons-io.jar"/>
                <property name="url" value="http://jakarta.apache.org/turbine/jars/commons-io.jar"/>
            </ant>

            That will check if $${lib.repo}/commons-io.jar exists, and if not,
            download it from $${url}

            or:

            <property name="cp" refid="project.class.path"/>
            <ant antfile="${depchecker.prefix}/depchecker.xml" target="checkRequiredClass">
                <property name="name" value="junit.jar"/>
                <property name="class" value="junit.framework.Test"/>
                <property name="classpath" value="${cp}"/>
            </ant>
            
            That will check if $${class} is in the classpath $${cp}.

            The properties are as follows:

            For checkRequiredFile:
            name:
                Name of the jar. Eg 'avalon-collections.jar'
            path:
                Path to named jar. Eg $${avalon-collections.jar}

            proj.home (optional):
                Path to local project which builds the jar. Only set if the jar
                could be local, eg another component.
            proj.target (optional) [dist.lite]:
                Ant script target to run in local project to build the jar

            url (optional):
                URL to retrieve jar if not present on the local filesystem
            
            For checkRequiredClass:
            name:
                Name of jar in which the class usually resides
            class:
                Name of class to check for
            classpath:
                String classpath (; or : separated) to search for $${class} in
            

            Algorithm is as follows:
            
            IF the directory ${proj.home} exists THEN:
                // The dependency is local; if the jar doesn't exist, we can build it 
                IF file ${path} does not exist THEN:
                   call ${proj.home}/build.xml's 'dist.lite' target to build that
                   project's jar, which will then build it's own dependencies if necessary
                ELSE we're fine
            ELSE
                // The dependency is remote; we can't build it,
                IF file ${path} does not exist THEN:
                    IF ${url} is present THEN:
                        do a HTTP GET to retrieve the jar to ${path}
                    ELSE
                        print an error saying "Can't find file ${path}"
                ELSE we're fine
            
                        =======================================================
            ]]></echo>
    </target>

    <!-- ====================================================== -->
    <!-- Dependency checking library                            -->
    <!-- ====================================================== -->

    <target name="checkCommon" description="Checks applying to all components" depends=""/>

    <target name="checkJUnit">
        <ant antfile="${depchecker.prefix}/depchecker.xml" target="checkRequiredClass">
            <property name="name" value="junit.jar"/>
            <property name="class" value="junit.framework.Test"/>
            <property name="classpath" value="${cp}"/>
            <property name="remedy" value="Download JUnit from http://www.junit.org and copy junit.jar ${nl}
           |   to ${ant.home}/lib"/>

        </ant>
    </target>
    <target name="checkJUnitPerf">
        <ant antfile="${depchecker.prefix}/depchecker.xml" target="checkRequiredClass">
            <property name="name" value="junitperf.jar"/>
            <property name="class" value="com.clarkware.junitperf.Timer"/>
            <property name="classpath" value="${cp}"/>
            <property name="remedy" value="1) Download and unpack JUnitPerf from ${nl}
           | http://www.clarkware.com/software/JUnitPerf.html ${nl}
           |   2) Copy the project's ant.properties.sample to ant.properties ${nl}
           |   3) In ant.properties, redefine the ${name} property ${nl}
           |      to point to the path of ${name} in your ${nl}
           |      downloaded distribution."/>

        </ant>
    </target>
    <target name="checkFramework">
        <ant antfile="${depchecker.prefix}/depchecker.xml" target="checkRequiredFile">
            <property name="name" value="avalon-framework.jar"/>
            <property name="path" value="${avalon-framework.jar}"/>
            <property name="remedy" value="1) Download and unpack Avalon Framework from ${nl}
           | http://jakarta.apache.org/builds/jakarta-avalon/release/framework ${nl}
           |   2) Copy the project's ant.properties.sample to ant.properties ${nl}
           |   3) In ant.properties, redefine the ${name} property ${nl}
           |      to point to the path of ${name} in your ${nl}
           |      downloaded Avalon."/>

        </ant>
    </target>
    <target name="checkCore">
        <ant antfile="${depchecker.prefix}/depchecker.xml" target="checkRequiredFile">
            <property name="name" value="excalibur-core.jar"/>
            <property name="path" value="${excalibur-core.jar}"/>
            <property name="proj.home" value="${basedir}/../all"/>
            <property name="proj.target" value="all"/>
        </ant>
    </target>
    <target name="checkScratchpad">
        <ant antfile="${depchecker.prefix}/depchecker.xml" target="checkRequiredFile">
            <property name="name" value="excalibur-scratchpad.jar"/>
            <property name="path" value="${excalibur-scratchpad.jar}"/>
        </ant>
    </target>
    <target name="checkEvent">
        <ant antfile="${depchecker.prefix}/depchecker.xml" target="checkRequiredFile">
            <property name="name" value="excalibur-event.jar"/>
            <property name="path" value="${excalibur-event.jar}"/>
            <property name="proj.home" value="${basedir}/../event"/>
        </ant>
    </target>
    <target name="checkThread">
        <ant antfile="${depchecker.prefix}/depchecker.xml" target="checkRequiredFile">
            <property name="name" value="excalibur-thread.jar"/>
            <property name="path" value="${excalibur-thread.jar}"/>
            <property name="proj.home" value="${basedir}/../thread"/>
        </ant>
    </target>
    <target name="checkInstrument">
        <ant antfile="${depchecker.prefix}/depchecker.xml" target="checkRequiredFile">
            <property name="name" value="excalibur-instrument.jar"/>
            <property name="path" value="${excalibur-instrument.jar}"/>
            <property name="proj.home" value="${basedir}/../instrument"/>
        </ant>
    </target>
    <target name="checkInstrumentManager">
       <ant antfile="${depchecker.prefix}/depchecker.xml" target="checkRequiredClass">
            <property name="name" value="excalibur-instrument-manager-0.1.jar"/>
            <property name="class" value="org.apache.avalon.excalibur.instrument.manager.interfaces.InstrumentManagerClient"/>
            <property name="classpath" value="${cp}"/>
        </ant>
    </target>
    <target name="checkCollections">
        <ant antfile="${depchecker.prefix}/depchecker.xml" target="checkRequiredFile">
            <property name="name" value="excalibur-collections.jar"/>
            <property name="path" value="${excalibur-collections.jar}"/>
            <property name="proj.home" value="${basedir}/../collections"/>
        </ant>
    </target>
    <target name="checkUtil">
        <ant antfile="${depchecker.prefix}/depchecker.xml" target="checkRequiredFile">
            <property name="name" value="excalibur-util.jar"/>
            <property name="path" value="${excalibur-util.jar}"/>
            <property name="proj.home" value="${basedir}/../util"/>
        </ant>
    </target>
    <target name="checkComponent">
        <ant antfile="${depchecker.prefix}/depchecker.xml" target="checkRequiredFile">
            <property name="name" value="excalibur-component.jar"/>
            <property name="path" value="${excalibur-component.jar}"/>
            <property name="proj.home" value="${basedir}/../component"/>
        </ant>
    </target>
    <target name="checkConcurrent">
        <ant antfile="${depchecker.prefix}/depchecker.xml" target="checkRequiredFile">
            <property name="name" value="excalibur-concurrent.jar"/>
            <property name="path" value="${excalibur-concurrent.jar}"/>
            <property name="proj.home" value="${basedir}/../concurrent"/>
        </ant>
    </target>
    <target name="checkPool">
        <ant antfile="${depchecker.prefix}/depchecker.xml" target="checkRequiredFile">
            <property name="name" value="excalibur-pool.jar"/>
            <property name="path" value="${excalibur-pool.jar}"/>
            <property name="proj.home" value="${basedir}/../pool"/>
        </ant>
    </target>
    <target name="checkLogkit">
        <ant antfile="${depchecker.prefix}/depchecker.xml" target="checkRequiredFile">
            <property name="name" value="avalon-logkit.jar"/>
            <property name="path" value="${avalon-logkit.jar}"/>
        </ant>
    </target>
    <target name="checkLogger">
        <ant antfile="${depchecker.prefix}/depchecker.xml" target="checkRequiredFile">
            <property name="name" value="excalibur-logger.jar"/>
            <property name="path" value="${excalibur-logger.jar}"/>
            <property name="proj.home" value="${basedir}/../logger"/>
        </ant>
    </target>
    <target name="checkManagerInterfaces">
        <ant antfile="${depchecker.prefix}/depchecker.xml" target="checkRequiredFile">
            <property name="name" value="excalibur-instrument-manager-interfaces.jar"/>
            <property name="path" value="${excalibur-instrument-manager-interfaces.jar}"/>
            <property name="proj.home" value="${basedir}/../instrument-manager"/>
        </ant>
    </target>
    <target name="checkTestcase">
        <ant antfile="${depchecker.prefix}/depchecker.xml" target="checkRequiredFile">
            <property name="name" value="excalibur-testcase.jar"/>
            <property name="path" value="${excalibur-testcase.jar}"/>
            <property name="proj.home" value="${basedir}/../testcase"/>
    </ant>
    </target><target name="checkThreadcontext">
        <ant antfile="${depchecker.prefix}/depchecker.xml" target="checkRequiredFile">
            <property name="name" value="excalibur-threadcontext.jar"/>
            <property name="path" value="${excalibur-threadcontext.jar}"/>
            <property name="proj.home" value="${basedir}/../threadcontext"/>
        </ant>
    </target>
    <!-- ====================================================== -->
    <!-- Call to ensure a class is present in the classpath     -->
    <!-- ====================================================== -->
    <target name="checkRequiredClass">
        <available classname="${class}" classpath="${classpath}" property="requirement.satisfied"/>
        <antcall target="checkRequiredClass.fail"/>
    </target>


    <!-- ====================================================== -->
    <!-- Call to ensure a file (usu. jar) is present. If not,   -->
    <!-- either build it (if local), or print an error (remote) -->
    <!-- ====================================================== -->
    <target name="checkRequiredFile" depends="checkIfLocal, checkRequiredFileLocal, checkRequiredFileRemote"/>

    <target name="checkIfLocal" if="proj.home">
        <available type="dir" file="${proj.home}" property="local"/>
    </target>

    <!--
    Check for a local requirement (another component). If not found,
    update_dependency will build it
    -->
    <target name="checkRequiredFileLocal" if="local">
        <available type="file" file="${path}" property="requirement.satisfied"/>
        <antcall target="update_dependency"/>
        <available type="file" file="${path}" property="build.succeeded"/>
        <antcall target="build.fail"/>
    </target>

    <!--
    Check for a remote requirement. If not found, checkRequiredFile.fail will
    print an error. Alternatively, we could do a HTTP get to retrieve the file
    -->
    <target name="checkRequiredFileRemote" unless="local">
        <available type="file" file="${path}" property="requirement.satisfied"/>
        <antcall target="get_dependency"/>
        <available type="file" file="${path}" property="get.succeeded"/>
        <antcall target="checkRequiredFile.fail"/>
    </target>

    <!-- =================================================================== -->
    <!-- Script called to recursively call another depencency.xml file in    -->
    <!-- another project, and then run the 'dist.lite' target.               -->
    <!-- =================================================================== -->
    <target name="update_dependency" description="Update files for one dependency" unless="requirement.satisfied">
        <echo>
            Couldn't find ${path} ${nl}
            Updating files from dependency ${proj.home}
        </echo>
        <!-- Set target if it wasn't previously set -->
        <property name="proj.target" value="${default.target}"/>
        <ant dir="${proj.home}" target="${proj.target}" inheritAll="false">
            <property name="skip.tests" value="true"/>
            <property name="skip.javadocs" value="true"/>
        </ant>
    </target>

    <target name="get_dependency" description="Retrieve a jar via HTTP" if="url" unless="requirement.satisfied">
        <get
            src="${url}"
            dest="${path}"
            verbose="true"
            usetimestamp="true"/>
        <echo>Retrieved ${path}</echo>
    </target>

    <target name="checkRequiredFile.fail" unless="get.succeeded">
        <property name="message" value="Can't find file: ${path}"/>
        <echo>
            .---------------------------------------------------------------.
            | FILE NOT FOUND                                                 |
            |                                                                |
            | ${message}
            |----------------------------------------------------------------|
            | Error when building module:                                    |
            | ${basedir} 
            |                                                                |
            | You must define the following property in order                |
            | to build:                                                      |
            |                                                                |
            | ${name} (currently "${path}")
            |                                                                |
            | Usually this is done by copying ant.properties.sample to       |
            | ant.properties and defining the property there. This may also  |
            | be done in ${user.home}/.ant.properties.                       |
            '----------------------------------------------------------------'
        </echo>
        <fail message="Failed requirement: file not found"/>
    </target>

    <target name="checkRequiredClass.fail" unless="requirement.satisfied">
        <property name="message" value="Can't find class: ${class}"/>
        <property name="remedy" value=""/>
        <echo>
            .----------------------------------------------------------------.
            | CLASS NOT FOUND                                                |
            |                                                                |
            | ${message}
            |----------------------------------------------------------------|
            | Error when building module:                                    |
            | ${basedir} 
            |                                                                |
            | A jar containing class:                                        |
            |   ${class}
            | must be in your classpath or Ant lib directory                 |
            |                                                                |
            | Typically it is in a jar called:                               |
            |   ${name}                                                      
            | Suggested Remedy:                                              |
            |   ${remedy}                                                                  
            '----------------------------------------------------------------'
        </echo>
        <fail message="Failed requirement: class not found"/>
    </target>

    <target name="build.fail" unless="build.succeeded">
        <echo>
            .-----------------------------------------------------------------.
            | BUILD FAILURE                                                   |
            |-----------------------------------------------------------------+
            | Error when building module:                                     |
            | ${basedir} 
            |                                                                 |
            |                                                                 |
            | The dependency-checking system tried to build the project:      |
            |   ${proj.home}
            | which should have provided the property:                        |
            |   ${name} = ${path}
            | However, after the build, no such file exists.                  |
            |                                                                 |
            | Typically this is because the required project changed the name |
            | of the jar it produces. If so, please correct this in           |
            | default.properties, ant.properties.sample or ant.properties     |
            '-----------------------------------------------------------------'
        </echo>
        <fail message="Failed Requirement"/>
    </target>

</project>
