<?xml version="1.0" encoding="UTF-8" ?>

<project name="avalon-merlin-cli" default="install" basedir="." 
    xmlns:x="antlib:org.apache.avalon.tools">

  <property file="build.properties"/>
  <import file="${project.home}/build/standard.xml"/>

  <property name="merlin.zip" value="avalon-merlin-3.3.1-DEV.zip"/>

  <target name="init" depends="standard.init">
    <x:filter key="avalon-merlin-cli" feature="version" 
       token="VERSION"/>
    <x:filter key="avalon-logging-logkit-impl" feature="uri" 
       token="LOGGING_IMPLEMENTATION"/>
    <x:filter key="avalon-merlin-impl" feature="uri" 
       token="MERLIN_IMPLEMENTATION"/>
    <x:filter key="avalon-activation-impl" feature="uri" 
       token="STANDARD_RUNTIME"/>
    <x:filter feature="system-classpath-for-windows" 
       token="WINDOWS-CLI-CLASSPATH"/>
    <x:filter feature="system-classpath-for-unix" 
       token="UNIX-CLI-CLASSPATH"/>
  </target>

  <target name="package" depends="standard.package">

    <mkdir dir="target/merlin"/>
    <copy todir="target/merlin">
      <fileset dir="target/build/etc" includes="bin/**"/>
    </copy>
    <mkdir dir="target/merlin/lib"/>
    <mkdir dir="target/merlin/system"/>

    <echo>GROUP: ${project.group}</echo>
    <echo>NAME: ${project.name}</echo>

    <copy todir="target/merlin/system">
      <fileset dir="${magic.cache}">
        <include name="avalon/**"/>
        <include name="commons-cli/jars/commons-cli-1.0.jar"/>
        <exclude name="avalon/test/**"/>
        <exclude name="avalon/tools/**"/>
        <exclude name="avalon/merlin/dist/**"/>
        <exclude name="avalon/merlin/jars/${project.name}**"/>
        <exclude name="avalon/planet/**"/>
      </fileset>
    </copy>
    <copy todir="target/merlin/system/${project.group}/jars">
      <fileset dir="target/deliverables/jars">
        <include name="${project.name}*.jar"/>
        <include name="${project.name}*.jar.*"/>
      </fileset>
    </copy>
    <copy todir="target/merlin" file="target/build/etc/merlin.properties.template"/>
    <mkdir dir="target/merlin/config"/>
    <copy todir="target/merlin/config" file="target/build/etc/kernel.xml"/>

    <mkdir dir="target/deliverables/dist"/>
    <zip zipfile="target/deliverables/dist/${merlin.zip}">
      <zipfileset dir="target/merlin" prefix="merlin" filemode="755" >
        <include name="bin/merlin"/>
        <include name="bin/merlinx"/>
        <include name="bin/*.sh"/>
      </zipfileset>
      <zipfileset dir="target/merlin" prefix="merlin">
        <include name="**" />
        <exclude name="bin/merlin"/>
        <exclude name="bin/merlinx"/>
        <exclude name="bin/*.sh"/>
      </zipfileset>
    </zip>

  </target>

</project>
