<?xml version="1.0" encoding="UTF-8" ?>

<project name="setup" default="setup" basedir=".">

  <!-- 
  TODO
  Check for jdk 1.4 as the build system prerequisite.
  Check for ant 1.6.1 minimum version.
  Check for dependent ant libs (junit, xsl stuff, etc.) 
  and if not available download and add to 
  ${user.home}/.ant/lib.
  -->

  <property file="index.properties"/>

  <property environment="ENV"/>

  <condition property="project.main.cache.declared" value="false">
    <isset property="project.main.cache"/>
  </condition>

  <condition property="project.main.cache.avalon.declared" value="false">
    <isset property="ENV.AVALON_HOME"/>
  </condition>

  <condition property="project.proxy.declared" value="false">
    <isset property="project.proxy.host"/>
  </condition>

  <target name="setup" depends="check-avalon,setup-repository,setup-antlib">
    <echo message="Setup complete."/>
  </target>

  <target name="check-avalon" unless="project.main.cache.avalon.declared">
    <!-- no AVALON_HOME declaration -->
    <property name="project.main.cache" value=".cache"/>
  </target>

  <target name="setup-cache-properties" depends="setup-avalon-cache,test-cache">
    <property name="cache.dir" value="${project.main.cache}"/>
    <property name="cache.tools.dir" value="${cache.dir}/avalon/tools"/>
    <property name="cache.tools.bars.dir" value="${cache.tools.dir}/bars"/>
    <property name="ant.lib" value="${user.home}/.ant/lib"/>
  </target>

  <target name="setup-repository" depends="setup-cache-properties,setup-proxy">
    <property name="tools.bar" value="${cache.tools.bars.dir}/avalon-tools.bar"/>
    <echo message="Preparing central system repository..."/>
    <mkdir dir="${cache.tools.bars.dir}"/>
    <get src="${avalon.tools.bar.url}" usetimestamp="true"
      dest="${tools.bar}"/>
    <unzip src="${tools.bar}" dest="${cache.tools.dir}">
      <patternset>
        <include name="**/*"/>
        <exclude name="META-INF/**"/>
        <exclude name="**/bars/**"/>
      </patternset>
    </unzip>
  </target>

  <target name="setup-antlib" depends="setup-repository">
    <echo message="Preparing supporting tools..."/>
    <mkdir dir="${ant.lib}"/>
    <copy toDir="${ant.lib}">
      <fileset dir="${cache.tools.dir}/jars">
        <include name="avalon-tools-*.jar"/>
      </fileset>
    </copy>
  </target>

  <target name="setup-avalon-cache" unless="project.main.cache.declared">
    <echo>[setup-avalon-cache]</echo>
    <property environment="ENV"/>
    <property name="project.main.cache" value="${ENV.AVALON_HOME}/repository"/>
    <condition property="avalon.home.undeclared" value="true">
      <contains string="${project.main.cache}" substring="{" />
    </condition>
    <echo>${avalon.home.undeclared}</echo>
  </target>

  <target name="test-cache" 
      depends="setup-avalon-cache" if="avalon.home.undeclared">
    <property name="project.main.cache" value=".cache"/>
  </target>

  <target name="setup-proxy" if="project.proxy.declared">
     <setproxy 
         proxyhost="${project.proxy.host}"
         proxyport="${project.proxy.port}"
	   proxyuser="${project.proxy.user}"
	   proxypassword="${project.proxy.password}"/>
  </target>

</project>
