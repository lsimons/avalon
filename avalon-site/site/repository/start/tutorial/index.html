
  

  
  

  
  

  

  
  

  
  

  
  

  

  

  

  

  

  
  
  
  
      
  

      
      
      
      
      
      
        
         
      
      

      
      
      
      

      
      
      

      

  
  

  
  

   
   


    
	
	

    
    
      
	
	
	<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

    <html>
      <head>
        
        
          <title>
            Merlin - 
          Avalon Repository - Tutorials
        
          </title>
        
        
        
        <style type="text/css">
          @import url("../../style/tigris.css");
          @import url("../../style/maven.css");
        </style>
        
        
        
        
        
        <link rel="stylesheet" href="../../style/print.css" type="text/css" media="print"></link>
        <meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1"></meta>
        
          <meta name="author" content="Stephen McConnell"></meta>
          <meta name="email" content="mcconnell@apache.org"></meta>
        
        
        
        
      </head>

      <body class="composite">

        <div id="banner">
          <table height="103" border="0" width="100%" cellpadding="8" cellspacing="0">
            <tr>
              
              <td>
                
                
                  
                  
                  
                    
                  
                  
                  
                  
                  
                  <a href="http://avalon.apache.org/">
                    <img border="0" alt="The Apache Software Foundation" src="http://avalon.apache.org/images/apache-avalon-logo.png" align="left"></img>
                  </a>
                
              </td>

              <td></td>
              

            </tr>
          </table>
        </div>
        <div id="breadcrumbs">
          <table border="0" width="100%" cellpadding="4" cellspacing="0">
            <tr>
              
              <td>
                <div align="right">
                  
                  
                  
                    
    
    
      
      
      
      <a href="http://apache.org/">Apache</a>
      
    
      |
      
      
      <a href="http://avalon.apache.org/">Avalon</a>
      
    
      |
      
      
      <a href="http://avalon.apache.org/product/framework/">Framework</a>
      
    
      |
      
      
      <a href="http://avalon.apache.org/product/containers/">Merlin</a>
      
    
      |
      
      
      <a href="http://avalon.apache.org/product/components/">Planet</a>
      
    
  
                  
                  
                </div>
              </td>
            </tr>
          </table>
        </div>
        
        <table border="0" width="100%" cellpadding="8" cellspacing="0"> 
          <tr valign="top">
            <td width="20%" id="leftcol">
              <div id="navcolumn">
                

                
                  
    <div>
      <strong>About Repository</strong>
      
    
    
    
    

    <div>
      <small>
      	
      	
      		<a href="../../about/index.html">Overview</a>
      	
      </small>
	  
        
      
    </div>
  
    
    
    
    

    <div>
      <small>
      	
      	
      		<a href="../../start/index.html">Getting Started</a>
      	
      </small>
	  
        
    
    
    
    

    <div>
      <small>
      	
      	
      		<a href="../../start/install/index.html">Installation</a>
      	
      </small>
	  
        
      
    </div>
  
    
    
    
    

    <div>
      <small>
      	
      		<b><a href="../../start/tutorial/index.html">Tutorials</a></b>
      	
      	
      </small>
	  
        
      
    </div>
  
      
    </div>
  
    
    
    
    

    <div>
      <small>
      	
      	
      		<a href="../../tools/index.html">Tools</a>
      	
      </small>
	  
        
      
    </div>
  
    </div>
  
    <div>
      <strong>Resources</strong>
      
    
    
    
    

    <div>
      <small>
      	
      	
      		<a href="../../api/index.html">Javadoc</a>
      	
      </small>
	  
        
      
    </div>
  
    
    
    
    

    <div>
      <small>
      	
      	
      		<a href="../../resources/download.html">Download</a>
      	
      </small>
	  
        
      
    </div>
  
    
    
    
    

    <div>
      <small>
      	
      	
      		<a href="../../resources/roadmap.html">Roadmap</a>
      	
      </small>
	  
        
      
    </div>
  
    </div>
  
    <div>
      <strong>Related Projects</strong>
      
    
    
    
    

    <div>
      <small>
      	
      	
      		<a href="http://avalon.apache.org/merlin">Merlin</a>
      	
      </small>
	  
        
      
    </div>
  
    
    
    
    

    <div>
      <small>
      	
      	
      		<a href="http://avalon.apache.org/util">Utilities</a>
      	
      </small>
	  
        
      
    </div>
  
    
    
    
    

    <div>
      <small>
      	
      	
      		<a href="http://avalon.apache.org/logging">Logging</a>
      	
      </small>
	  
        
      
    </div>
  
    </div>
  
                
                
                
                

                
                
                <div>
                  <strong>Project Documentation</strong>
                  
                  <div>
                    <small>
                      <a href="../../project-info.html">Project Info</a>
                    </small>
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                  </div>
                  <div>
                    <small>
                      <a href="../../maven-reports.html">Project Reports</a>
                    </small>
                    
					
                    
                    
                    
                    
                    
                  </div>
                  
                  
                </div>
              
              
                
                
                
                
              
                
              </div>
            </td>
            <td rowspan="2">
              <div id="bodycol">
                
                <div class="app">
                  
                  
    <div class="h3">
      
      
        <h3>
          <a name="Avalon Repository - Tutorials">Avalon Repository - Tutorials</a>
        </h3>
      
      
    <p>
      The following example is taken from the the 
         
    <a href="http://avalon.apache.org/merlin">Merlin</a>
   project. 
         It demonstrates the creation of an embedded logging service using
         the Repository Facility builder, factory and criteria handling 
         patterns.
    </p>
   
    <div class="h4">
      
      
        <h4>
          <a name="Creating an InitialContext ">Creating an InitialContext </a>
        </h4>
      
      
    <p>
      
   The following code fragment defines a cache directory for the 
   repository system to use when loading resources needed in your 
   embedded application - and provides the directory as an argument 
   when creating a new InitialContext object.  The InitialContext is
   your hook into the repository system and the embedding machinery.
          
    </p>
   
    <div id="source">
      <pre>
File cache = new File( "my-cache" );
InitialContext context = new DefaultInitialContext( cache );
          </pre>
    </div>
  
    </div>
  
    <div class="h4">
      
      
        <h4>
          <a name="Declare what you want to embed">Declare what you want to embed</a>
        </h4>
      
      
    <div id="source">
      <pre>
String spec =
  "artifact:avalon-logging/avalon-logkit?version=1.0-SNAPSHOT"
Artifact artifact =
  Artifact.createArtifact( spec );
          </pre>
    </div>
  
    <p>
      
   An artifact is a logical reference to a jar file (or other type
   of resource) that the repository can access. The avalon-repository
   system uses artifact references as the key to locating meta data
   about embedded classloaders.  The classloader meta data is
   maintained as a properties file with the .meta extension.  For
   example the above artifact meta address translates to: 
          
    </p>
   
    <div id="source">
      <pre>
[host]/avalon-logging/jars/avalon-logkit-impl-1.0-SNAPSHOT.jar.meta 
          </pre>
    </div>
  
    <p>
      
   The content of the meta file is automatically generated using the
   avalon-plugin avalon:artifact goal. Two examples of factory meta 
   are provides, one concerning the 
    <a href="logkit.meta">logkit</a>
  
   factory and a second describing the 
    <a href="merlin.meta">merlin</a>
  
   factory.
          
    </p>
   
    <p>
      
   The contents of the meta file includes:
          
    </p>
   
    <ul>
      
            
    <li>
      an ordered list of jar files that are required to
       construct a classloader for the embedded application
    </li>
   

            
    <li>
      the name of a factory class to be used as the embedded
       instance creator
    </li>
   
          
    </ul>
   
    </div>
  
    <div class="h4">
      
      
        <h4>
          <a name="Create the factory">Create the factory</a>
        </h4>
      
      
    <p>
      
   Using the initial context and the artifact you now have everything
   you need to create you embedded instance.
          
    </p>
   
    <div id="source">
      <pre>
Builder builder = m_context.newBuilder( artifact );
Factory factory = builder.getFactory();
          </pre>
    </div>
  
    <p>
      
   Behind the scenes the avalon-repository system has gone off, pulled
   down the meta data, downloaded and cached all of the classloader
   entries, constructed a new classloader, and instantiated the
   factory.
          
    </p>
   
    </div>
  
    <div class="h4">
      
      
        <h4>
          <a name="Parameterizing the factory ">Parameterizing the factory </a>
        </h4>
      
      
    <p>
      
   The factory object is the central entry point of the embedded
   application - it is responsible for instantiation of the
   embedded instance based on a supplied criteria.  The initial
   criteria (the defaults) are established by the factory in
   response to the following operation:
          
    </p>
   
    <div id="source">
      <pre>
Map criteria = factory.createDefaultCriteria();
          </pre>
    </div>
  
    <p>
      
   Based on the documentation about the facility you are embedding
   you can update the criteria using application specific keys. All
   of the Merlin related criteria instances use the avalon-util
   Criteria as the abstract base class for the map implementations.  
   This provides support for key and type validation under the put 
   operations and type coercion on get operations.
          
    </p>
   
    <p>
      
   For example:
          
    </p>
   
    <div id="source">
      <pre>
String key = "avalon.logging.configuration";
File file = new File( "logging.xml" );
criteria.put( key, file );
          </pre>
    </div>
  
    <p>
      
   Parameterization of the criteria is typically different for
   each embedding scenario.  A CLI handler will for example adapt
   to the command line operations and set criteria values accordingly.
   A web application may set the criteria based on parameters declared
   in a web.xml file.  Typically the embedding class acts as the
   adapter between the embedded context and the factory.
          
    </p>
   
    </div>
  
    <div class="h4">
      
      
        <h4>
          <a name="Embedded instance creation">Embedded instance creation</a>
        </h4>
      
      
    <p>
      
   Creation of the embedded instance is now a simple one line
   operation:
          
    </p>
   
    <div id="source">
      <pre>
Object object = factory.create( criteria );
          </pre>
    </div>
  
    <p>
      
   The object that is created is the embedded application.  In this
   example its a logging manager that uses the logkit implementation.
   However, it could have been the Merlin kernel.  The only difference
   between the Merlin scenario and the logging manager scenario is
   the initial artifact and the actions taken to parameterize the
   criteria. 
          
    </p>
   
    </div>
  
    <div class="h4">
      
      
        <h4>
          <a name="Putting it all together">Putting it all together</a>
        </h4>
      
      
    <div id="source">
      <pre>
//
// create the initial referecne
//

File cache = new File( "my-cache" );
InitialContext context = new DefaultInitialContext( cache );

// 
// define the artifact 
//

String spec =
  "artifact:avalon-logging/avalon-logkit?version=1.0-SNAPSHOT"
Artifact artifact =
  Artifact.createArtifact( spec );

//
// create the builder, get the factory and the initial criteria
//

Builder builder = m_context.newBuilder( artifact );
Factory factory = builder.getFactory();
Map criteria = factory.createDefaultCriteria();

//
// customize the crieria
//

String key = "avalon.logging.configuration";
File file = new File( "logging.xml" );
criteria.put( key, file );

//
// create the embedded instance
//

LoggingManager manager = 
  (LoggingManager) factory.create( criteria );

          </pre>
    </div>
  
    </div>
  
    <div class="h4">
      
      
        <h4>
          <a name="Special Notes">Special Notes</a>
        </h4>
      
      
    <p>
      
The avalon-repository API provides special support for initial context propergation to the factory that is being created.  The allows the factory to embed additional applications within itself using the classloader it is constructed under, together with the original initial context.

    </p>
   
    <p>
      
The following code snipet demonstrates a factory that caches references to the classloader and initial context so that it can use these is subsequent embedding of services during its own create method implementation.

    </p>
   
    <div id="source">
      <pre>
public class WidgetFactory implements Factory
{
    private final InitialContext m_context;
    private final ClassLoader m_classloader;

    public WidgetFactory( 
      InitialContext context, ClassLoader classloader )
    {
        m_context = context;
        m_classloader = classloader;
    }

    public Map getDefaultCriteria()
    {
        return new WidgetContext();
    }

    public Object create()
    {
        return create( getDefaultCriteria() );
    }

    public Object create( Map criteria )
    {
        //
        // embed something into this factory using 
        // the classloader that established this factory 
        // as the parent classloader of the thing we are
        // embedding
        //

        Artifact artifact = 
          (Artifact) criteria.get( "gizmo.artifact" );
        Builder builder = m_context.newBuilder( m_classloader, gizmo );
        Gizmo gizmo = builder.getFactory().create();

        //
        // do other stuff
        //

        return new DefaultWidget( gizmo );
    }
}
          </pre>
    </div>
  
    </div>
  
    </div>
  
                  
                  
                  
                  
                  
                </div>
              </div>
            </td>
          </tr>
        </table>
        <div id="footer">
          <table border="0" style="width:100%" cellpadding="4" cellspacing="0">
            
            <tr>
              <td>
                
                  
                    
                    
                      © 1997-2004, The Apache Software Foundation
                    
                  
                  
                

                
              </td>
              
            </tr>
          </table>
        </div>
      </body>
    </html>
  