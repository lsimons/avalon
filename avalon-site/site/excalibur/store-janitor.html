
  

  
  

  
  

  

  
  

  
  

  
  

  

  

  

  

  

  
  
  
  
      
  

      
      
      
      
      
      
        
         
      
      

      
      
      
      

      
      
      

      

  
  

  
  

   
   


    
	
	

    
    
      
	
	
	<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

    <html>
      <head>
        
        
          <title>
            Avalon Sandbox - 
          The Store Janitor
        
          </title>
        
        
        
        <style type="text/css">
          @import url("./style/tigris.css");
          @import url("./style/maven.css");
        </style>
        
        
        
        
        
        <link rel="stylesheet" href="./style/print.css" type="text/css" media="print"></link>
        <meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1"></meta>
        
          <meta name="author" content="Avalon Documentation Team"></meta>
          <meta name="email" content="dev@avalon.apache.org"></meta>
        
        
        
        
      </head>

      <body class="composite">

        <div id="banner">
          <table border="0" width="100%" cellpadding="8" cellspacing="0">
            <tr>
              
              <td>
                
                
                  
                  
                  
                    
                  
                  
                  
                  
                  
                  <a href="http://avalon.apache.org/">
                    <img border="0" alt="Apache Software Foundation" src="http://avalon.apache.org/images/apache-avalon-logo.png" align="left"></img>
                  </a>
                
              </td>

              
              <td>
                <div id="login" align="right">
                  
                  
                </div>
              </td>
            </tr>
          </table>
        </div>
        <div id="breadcrumbs">
          <table border="0" width="100%" cellpadding="4" cellspacing="0">
            <tr>
              
              <td>
                <div align="right">
                  
                  
                  
                    
    
    
      
      
      
      <a href="http://apache.org/">Apache</a>
      
    
      |
      
      
      <a href="http://avalon.apache.org/">Avalon</a>
      
    
      |
      
      
      <a href="http://avalon.apache.org/product/framework/">Framework</a>
      
    
      |
      
      
      <a href="http://avalon.apache.org/product/containers/">Containers</a>
      
    
      |
      
      
      <a href="http://avalon.apache.org/product/components/">Components</a>
      
    
  
                  
                  
                </div>
              </td>
            </tr>
          </table>
        </div>
        
        <table border="0" width="100%" cellpadding="8" cellspacing="0"> 
          <tr valign="top">
            <td width="20%" id="leftcol">
              <div id="navcolumn">
                

                
                  
    <div>
      <strong>About Excalibur</strong>
      
    
    
    
    

    <div>
      <small>
      	
      	
      		<a href="index.html">Overview</a>
      	
      </small>
	  
        
      
    </div>
  
    
    
    
    

    <div>
      <small>
      	
      	
      		<a href="configuration/index.html">Configuration</a>
      	
      </small>
	  
        
      
    </div>
  
    
    
    
    

    <div>
      <small>
      	
      	
      		<a href="i18n/index.html">I18N</a>
      	
      </small>
	  
        
      
    </div>
  
    
    
    
    

    <div>
      <small>
      	
      	
      		<a href="sourceresolve-index.html">Sourceresolver</a>
      	
      </small>
	  
        
      
    </div>
  
    
    
    
    

    <div>
      <small>
      	
      	
      		<a href="store-index.html">Store</a>
      	
      </small>
	  
        
      
    </div>
  
    
    
    
    

    <div>
      <small>
      	
      	
      		<a href="component.html">ECM</a>
      	
      </small>
	  
        
      
    </div>
  
    </div>
  
    <div>
      <strong>Project</strong>
      
    
    
    
    

    <div>
      <small>
      	
      	
      		<a href="http://avalon.apache.org/download.cgi">Download</a>
      	
      </small>
	  
        
      
    </div>
  
    
    
    
    

    <div>
      <small>
      	
      	
      		<a href="no-docs-available.html">Where's my documentation???</a>
      	
      </small>
	  
        
      
    </div>
  
    
    
    
    

    <div>
      <small>
      	
      	
      		<a href="http://avalon.apache.org/excalibur/api/">Javadocs</a>
      	
      </small>
	  
        
      
    </div>
  
    </div>
  
                
                
                
                

                
                
                <div>
                  <strong>Project Documentation</strong>
                  <div>
                    <small>
                      <a href="./index.html">About Avalon Excalibur</a>
                    </small>
                  </div>
                  <div>
                    <small>
                      <a href="./project-info.html">Project Info</a>
                    </small>
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                  </div>
                  <div>
                    <small>
                      <a href="./maven-reports.html">Project Reports</a>
                    </small>
                    
					
                    
                    
                      
                      
                    
                      
                      
                    
                      
                      
                    
                      
                      
                    
                      
                      
                    
                    
                    
                    
                  </div>
                  
                    
                  
                  
                  
                  
                  
                    <div>
                      <small>
                        
                        <a href="http://maven.apache.org/development-process.html">Development Process</a>
                      </small>
                    </div>
                  
                </div>
              
              
                
                
                
                
              
                
              </div>
            </td>
            <td rowspan="2">
              <div id="bodycol">
                
                <div class="app">
                  
                  
    <div class="h3">
      
      
        <h3>
          <a name="Goal">Goal</a>
        </h3>
      
      
    <p>
      This document describes the usage of the StoreJanitor.
    </p>
   
    </div>
  
    <div class="h3">
      
      
        <h3>
          <a name="Description">Description</a>
        </h3>
      
      
    <p>
      The implementation is quit simple! Every implementation of a Store can register in the 
  StoreJanitor. It checks in a configurable interval if memory is running low. If low, 
  it greps via Round Robin a victim (Store) and frees xx% of all emlements in this Store. 
  After that the StoreJanitor sleeps and waits for the next iteration.
    </p>
   
    <p>
      The StoreJanitor is very useful for web applications that use the store as
   a in-memory cache. The StoreJanitor helps in avoiding OutOfMemory exceptions.
    </p>
   
    </div>
  
    <div class="h3">
      
      
        <h3>
          <a name="Configuration">Configuration</a>
        </h3>
      
      
    <p>
      The Store Janitor can be configured with a few options:
   
    </p>
   
    <ul>
      
       
    <li>
      
    <em>
      freememory
    </em>
   : How many bytes shall be always free in the JVM (Default: 1mb)
    </li>
   
       
    <li>
      
    <em>
      heapsize
    </em>
   : Maximum possible size of the JVM memory consumption (Default: 64mb)
    </li>
   
       
    <li>
      
    <em>
      cleanupthreadinterval
    </em>
   : How often (sec) shall run the cleanup thread (Default: 10s)
    </li>
   
       
    <li>
      
    <em>
      adaptivethreadinterval
    </em>
    (experimental): Enable adaptive algorithm to determine thread interval
           (Default: false) When true, 
    <code>
      cleanupthreadinterval
    </code>
    defines the maximum cleanup interval.
           Cleanup interval then is determined based on the memory fill rate: the faster memory is filled in,
           and the less free memory is left, the shorter is the cleanup time.
    </li>
   
       
    <li>
      
    <em>
      threadpriority
    </em>
   : priority of the thread (1-10). (Default: 10)
    </li>
   
       
    <li>
      
    <em>
      percent_to_free
    </em>
   : What fraction of the store to free when memory is low (1-100). (Default: 10%)
    </li>
   
       
    <li>
      
    <em>
      invokegc
    </em>
   : Invoke the gc on low memory first (true|false; default: false)
    </li>
   
      
    </ul>
   
    <p>
      The right configuration is very important, because wrong settings can 
    cause a high system load. Let's have a look at a sample configuration.
    </p>
   
    <div class="h4">
      
      
        <h4>
          <a name="Example configuration">Example configuration</a>
        </h4>
      
      
    <ul>
      
    <li>
      Tomcat settings in tomcat.sh or tomcat.bat:
    </li>
   
    </ul>
   
    <div id="source">
      <pre>
%_RUNJAVA% %TOMCAT_OPTS% -Dtomcat.home="%TOMCAT_HOME%" \
  -Xmx200000000 org.apache.tomcat.startup.Tomcat %2 %3 %4 %5 %6 %7 %8 %9
    </pre>
    </div>
  
    <ul>
      
    <li>
      StoreJanitor settings:
    </li>
   
    </ul>
   
    <p>
      The freememory and heapsize paramter always depends on the Xmx 
    parameter.
    </p>
   
    <div id="source">
      <pre>
  &lt;!--+
      | Store Janitor: the store garbage collector and memory usage controller.
      |
      | Be careful with the heapsize and freememory parameters. Wrong values
      | can cause high cpu usage. Example configuration:
      | Jvm settings:
      |    -Xmx200000000
      | store-janitor settings:
      |    &lt;parameter name="freememory" value="5000000"/&gt;
      |    &lt;parameter name="heapsize" value="196000000"/&gt;
      |
      | It is recommended to have heapsize equal to -Xmx, especially on Sun's
      | JVM which are unable to shrink its heap once it grows above minimum.
      | Freememory should be greater than amount of memory necessary for normal
      | application operation.
      | BUT: The heap size of the memory of the JVM is a little bit less than
      |      the value you specify for -Xmx, so you have to set the heapsize
      |      for the store janitor to a value which is lower (2% less seems
      |      to be a working value).
      +--&gt;
  &lt;store-janitor logger="core.store.janitor"&gt;
     &lt;!-- How much free memory shall be available in the jvm --&gt;
     &lt;parameter name="freememory" value="2048000"/&gt;
     &lt;!-- Indicates the limit of the jvm memory consumption. The default max
          heapsize for Sun's JVM is (almost) 64Mb --&gt;
     &lt;parameter name="heapsize" value="66600000"/&gt;
     &lt;!-- How often shall the cleanup thread check memory --&gt;
     &lt;parameter name="cleanupthreadinterval" value="10"/&gt;
     &lt;!-- Experimental adaptive algorithm for cleanup interval
     &lt;parameter name="adaptivethreadinterval" value="true"/&gt;
     --&gt;
     &lt;!-- Indicates the thread priority of the cleanup thread --&gt;
     &lt;parameter name="threadpriority" value="5"/&gt;
     &lt;!-- How much percent of the elements of each registered Store
          shall be removed when low on memory. Default 10% --&gt;
     &lt;parameter name="percent_to_free" value="10"/&gt;
     &lt;!-- Invoke the garbage collector when low memory is reached --&gt;
     &lt;parameter name="invokegc" value="false"/&gt;
  &lt;/store-janitor&gt;
    </pre>
    </div>
  
    <p>
      It is recommended to have 
    <code>
      heapsize
    </code>
    equal to -Xmx, especially
    on Sun's JVM which are unable to shrink its heap once it grows above minimum. 
    
    <code>
      freememory
    </code>
    should be greater than amount of memory necessary for normal 
    application operation. But the heap size of the memory of the JVM is a little bit less than
   the value you specify for -Xmx, so you have to set the heapsize
   for the store janitor to a value which is lower (2% less seems
    to be a working value)
    
    </p>
   
    <p>
       The 
    <code>
      cleanupthreadinterval
    </code>
    defines the interval of the background 
    thread which checks memory in seconds. Also this paramter should configured wisely. 
    A to short interval can cause also a high system load. The 
    
    <code>
      threadpriority
    </code>
    defines the priority of the background thread. 
    1 is lowest level and 10 the highest.
    </p>
   
    <p>
      
    The 
    <code>
      percent_to_free
    </code>
    parameter describes, how much percent of the 
    elements of each registered Store shall be removed when low on memory.
    
    </p>
   
    </div>
  
    </div>
  
                  
                  
                  
                  
                  
                </div>
              </div>
            </td>
          </tr>
        </table>
        <div id="footer">
          <table border="0" style="width:100%" cellpadding="4" cellspacing="0">
            
            <tr>
              <td>
                
                  
                    
                    
                      © 1997-2003, Apache Software Foundation
                    
                  
                  
                

                
              </td>
              
            </tr>
          </table>
        </div>
      </body>
    </html>
  