<?xml version="1.0"?>

<project default="check"
    xmlns:j="jelly:core"
    xmlns:ant="jelly:ant"
    xmlns:deploy="deploy">

    <!-- include the avalon-wide custom project properties -->
    <property file="${basedir}/project.properties"/>

    
    <preGoal name="jar:jar">
        <ant:taskdef name="collect-meta"
            classname="org.apache.avalon.fortress.tools.ComponentMetaInfoCollector">
            <ant:classpath>
                <ant:path refid="maven.dependency.classpath"/>
                <ant:pathelement path="${maven.build.dir}/classes"/>
            </ant:classpath>
        </ant:taskdef>

        <collect-meta destdir="${maven.build.dir}/classes">
            <fileset dir="src/java"/>
        </collect-meta>

        <ant:copy todir="${java.build.dir}">
            <ant:fileset dir="${java.src.dir}">
                <ant:exclude name="**/*.java"/>
                <ant:exclude name="**/package.html"/>
            </ant:fileset>
        </ant:copy>
    </preGoal>


    <postGoal name="jar:jar">
        <jar jarfile="${maven.build.dir}/${maven.final.name}-viewer.jar"
             basedir="${maven.build.dir}/classes"
             includes="**/*.*">
          <manifest>
            <attribute name="Main-Class" value="org.apache.avalon.fortress.examples.viewer.Main"/>
            <attribute name="Class-Path" value="logkit-1.2.jar avalon-framework-4.1.4.jar avalon-fortress-complete-1.1-dev.jar concurrent-1.3.1.jar commons-collections-2.1.jar"/>
          </manifest>
        </jar>

        <jar jarfile="${maven.build.dir}/${maven.final.name}-swing.jar"
             basedir="${maven.build.dir}/classes"
             includes="**/*.*">
          <manifest>
            <attribute name="Main-Class" value="org.apache.avalon.fortress.examples.swing.Main"/>
            <attribute name="Class-Path" value="logkit-1.2.jar avalon-framework-4.1.4.jar avalon-fortress-complete-1.1-dev.jar concurrent-1.3.1.jar commons-collections-2.1.jar"/>
          </manifest>
        </jar>

        <jar jarfile="${maven.build.dir}/${maven.final.name}-extended.jar"
             basedir="${maven.build.dir}/classes"
             includes="**/*.*">
          <manifest>
            <attribute name="Main-Class" value="org.apache.avalon.fortress.examples.extended.Main"/>
            <attribute name="Class-Path" value="logkit-1.2.jar avalon-framework-4.1.4.jar avalon-fortress-complete-1.1-dev.jar concurrent-1.3.1.jar commons-collections-2.1.jar"/>
          </manifest>
        </jar>


	<!-- build webapp -->

        <mkdir dir="${maven.build.dir}/servlet"/>
        <mkdir dir="${maven.build.dir}/servlet/WEB-INF"/>
        <mkdir dir="${maven.build.dir}/servlet/WEB-INF/lib"/>

        <deploy:copy-deps
                todir="${maven.build.dir}/servlet/WEB-INF/lib"
                excludes="servletapi,junit,avalon-fortress-tools"/>

        <copy todir="${build.dir}/servlet/WEB-INF"
              file="${maven.src.dir}/conf/web.xml"/>

        <jar jarfile="${maven.build.dir}/${maven.final.name}-servlet.war"
	     basedir="${maven.build.dir}/servlet"
	     includes="**/*.*" />
     </postGoal>

   <goal name="run:swing">
    <attainGoal name="jar:jar"/>
       <java classname="org.apache.avalon.fortress.examples.swing.Main" fork="true" failonerror="true">
         <classpath>
           <pathelement path="${maven.build.dir}/${maven.final.name}.jar"/>
          <j:forEach var="dep" items="${pom.dependencies}">
           <pathelement path="${maven.repo.local}/${dep.artifactDirectory}/jars/${dep.artifact}"/>
          </j:forEach>
         </classpath>
       </java>
    </goal>

   <goal name="run:viewer">
    <attainGoal name="jar:jar"/>
       <java classname="org.apache.avalon.fortress.examples.viewer.Main" fork="true" failonerror="true">
         <classpath>
           <pathelement path="${maven.build.dir}/${maven.final.name}.jar"/>
          <j:forEach var="dep" items="${pom.dependencies}">
           <pathelement path="${maven.repo.local}/${dep.artifactDirectory}/jars/${dep.artifact}"/>
          </j:forEach>
         </classpath>
       </java>
    </goal>

   <goal name="run:extended">
    <attainGoal name="jar:jar"/>
       <java classname="org.apache.avalon.fortress.examples.extended.Main" fork="true" failonerror="true">
         <classpath>
           <pathelement path="${maven.build.dir}/${maven.final.name}.jar"/>
          <j:forEach var="dep" items="${pom.dependencies}">
           <pathelement path="${maven.repo.local}/${dep.artifactDirectory}/jars/${dep.artifact}"/>
          </j:forEach>
         </classpath>
       </java>
    </goal>


</project>
