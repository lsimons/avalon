<project default="jar:install" xmlns:maven="jelly:maven" xmlns:j="jelly:core" xmlns:util="jelly:util" xmlns:ant="jelly:ant">

  <ant:property name="maven.jar.manifest.extensions.add" value="false"/>
  <ant:property file="${basedir}/../../version.properties"/>

  <preGoal name="jar:jar">
    <maven:snapshot project="${pom}"/>
    <j:set var="timestamp" value="${snapshotSignature.substring(pom.artifactId.length)}"/>
    <ant:property name="merlin.timestamp" value="${timestamp}"/>
<ant:echo file="${basedir}/snapshot.properties">
build.signature = ${snapshotSignature}
</ant:echo>
    <j:forEach var="dep" items="${pom.dependencies}">
      <j:if test="${dep.getId() != 'junit:junit'}">
        <unzip src="${pom.getDependencyPath( dep.getId() )}" 
          dest="${maven.build.dir}/classes"/>
      </j:if>
    </j:forEach>
  </preGoal>

  <goal name="build" prereqs="jar:install">
    <ant:property environment="env"/>
    <ant:property name="merlinEnvironment" value="${env.MERLIN_HOME}"/>
    <j:if test="${merlinEnvironment != ''}">
       <ant:property name="merlin.home" value="${merlinEnvironment}"/>
    </j:if>
    <ant:property name="merlin.home" value="${user.home}/.merlin"/>
    <copy toDir="${merlin.home}/bin/lib" file="${maven.build.dir}/${maven.final.name}.jar"/>
  </goal>

</project>
