<project default="jar:install" xmlns:maven="jelly:maven" xmlns:j="jelly:core" xmlns:util="jelly:util" xmlns:ant="jelly:ant">

  <postGoal name="java:prepare-filesystem">
    <attainGoal name="avalon:artifact"/>
    <ant:copy toDir="${maven.repo.local}/${pom.groupId}/jars" 
       file="${maven.build.dir}/${pom.artifactId}-${pom.currentVersion}.jar.meta" verbose="yes"/>
  </postGoal>

  <!--
  Create the default merlin.properties containing the 
  implementation identifier.  This is subsequently copied 
  into the maven repository under the path 
  ${maven.repo.local}/${pom.groupId}/properties/merlin.properties
  and is used by the embedding applications such as cli, plugin,
  unit test, etc. 
  -->

  <postGoal name="java:compile">

    <ant:copy toFile="${maven.build.dir}/classes/merlin.properties">
      <fileset dir="${basedir}/conf">
        <include name="merlin.template"/>
      </fileset>
      <filterset>
        <filter token="MERLIN_IMPLEMENTATION" 
           value="artifact:${pom.groupId}/${pom.artifactId}#${pom.currentVersion}"/>
        <filter token="LOGGING_IMPLEMENTATION" 
           value="${merlin.logging.implementation}"/>
        <filter token="STANDARD_RUNTIME" 
           value="${merlin.runtime.standard.implementation}"/>
        <filter token="SECURE_RUNTIME" 
           value="${merlin.runtime.csi.implementation}"/>
      </filterset>
    </ant:copy>

    <!--
    <ant:echo file="${maven.build.dir}/classes/merlin.properties">
#
# merlin system implementation
merlin.implementation = ${pom.groupId}:${pom.artifactId};${pom.currentVersion}

#
# logging implementation
merlin.logging.implementation = ${merlin.logging.implementation}

#
# runtime implementation
merlin.runtime.standard.implementation = ${merlin.runtime.standard.implementation}

#
# runtime code secure implementation
merlin.runtime.csi.implementation = ${merlin.runtime.csi.implementation}

#
# EOF
#
</ant:echo>
    -->
    <ant:mkdir dir="${maven.repo.local}/${pom.groupId}/properties"/>
    <ant:copy toDir="${maven.repo.local}/${pom.groupId}/properties" 
       file="${maven.build.dir}/classes/merlin.properties" verbose="yes"/>
  </postGoal>

</project>
