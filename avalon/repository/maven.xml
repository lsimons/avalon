<project default="avalon:build" xmlns:maven="jelly:maven" xmlns:j="jelly:core" xmlns:util="jelly:util" xmlns:ant="jelly:ant">

  <!--
  ==============================================================================
  switches 
  ==============================================================================
  -->

  <ant:property name="avalon.snapshot" value="true"/>

  <!--
  ==============================================================================
  dependent properties 
  ==============================================================================
  -->

  <ant:property name="avalon.cli.version" value="1.3-SNAPSHOT"/>

  <!--
  ==============================================================================
  derived properties 
  ==============================================================================
  -->

  <ant:property name="maven.dist.assembly.dir"
    value="${maven.build.dir}/temp"/>
  <ant:property name="maven.dist.bin.archive.dir"
    value="${maven.dist.assembly.dir}/bin"/>
  <ant:property name="maven.dist.src.archive.dir"
    value="${maven.dist.assembly.dir}/src"/>
  <ant:property name="maven.dist.bin.assembly.dir"
    value="${maven.dist.assembly.dir}/bin/avalon-${pom.currentVersion}"/>
  <ant:property name="maven.dist.src.assembly.dir"
    value="${maven.dist.assembly.dir}/src/${pom.artifactId}"/>
  <ant:property name="maven.dist.dir"
    value="${maven.build.dir}/distributions"/>

  <!--
  ==============================================================================
  structural properties 
  ==============================================================================
  -->

  <ant:property name="pom.specificationVersion" value="1.2"/>
  <ant:property name="pom.organization.identifier" value="ASF"/>
  <ant:property name="maven.docs.src" value="${basedir}/site/xdocs"/>
  <ant:property file="project.properties"/>

  <!--
  ==============================================================================
  build the repository package
  ==============================================================================
  -->

  <goal name="avalon:build" description="Build the Repository.">

    <maven:reactor basedir="${basedir}"
      includes="*/project.xml"
      excludes="project.xml"
      goals=""
      banner="Building:"
      ignoreFailures="false"
      postProcessing="true" />

    <ant:copy todir="${maven.build.dir}/jars">
      <j:forEach var="child" items="${reactorProjects}">
        <ant:fileset dir="${child.file.parentFile}/target">
          <ant:include name="${child.artifactId}-${child.currentVersion}.jar"/>
          <ant:include name="${child.artifactId}-${child.currentVersion}.jar.meta"/>
        </ant:fileset>
      </j:forEach>
    </ant:copy>
    <j:forEach var="child" items="${reactorProjects}">
      <j:set var="path" value="${child.artifactId}-${child.currentVersion}"/>
      <util:file var="jarFile" name="${maven.build.dir}/jars/${path}.jar"/>
      <j:if test="${jarFile.exists()}">
        <checksum file="${jarFile}"/>
        <j:if test="${maven.gpg.exe != ''}">
          <ant:exec executable="${maven.gpg.exec}">
            <ant:arg value="--armour"/>
            <ant:arg value="--yes"/>
            <ant:arg value="-b"/>
            <ant:arg value="${jarFile}"/>
          </ant:exec>
        </j:if>
      </j:if>
      <util:file var="metaFile" name="${maven.build.dir}/jars/${path}.jar.meta"/>
      <j:if test="${metaFile.exists()}">
        <checksum file="${metaFile}"/>
        <j:if test="${maven.gpg.exe != ''}">
          <ant:exec executable="${maven.gpg.exec}">
            <ant:arg value="--armour"/>
            <ant:arg value="--yes"/>
            <ant:arg value="-b"/>
            <ant:arg value="${metaFile}"/>
          </ant:exec>
        </j:if>
      </j:if>
    </j:forEach>
  </goal>

  <goal name="avalon:clean" prereqs="clean" description="Clean all subprojects.">
    <maven:reactor
      basedir="${basedir}"
      includes="**/project.xml"
      excludes="project.xml"
      goals="clean:clean"
      banner="Cleaning subproject:"
      ignoreFailures="true"/>
  </goal>

  <goal name="avalon:site">
    <maven:reactor basedir="${basedir}"
      includes="platform.xml"
      goals="xjavadoc,site"
      banner="Building site:"
      ignoreFailures="false"/>
  </goal>

  <goal name="avalon:dist" prereqs="avalon:build,avalon:site,xdist">
  </goal>

  <goal name="xdist"
    prereqs="xdist:build"
    description="Build a complete distribution.">
  </goal>
        
  <goal
    name="xdist:build"
    prereqs="xdist:build-setup,xdist:build-bin,xdist:build-src"
    description="Build a complete distribution.">
  </goal>

  <goal
    name="xdist:build-setup"
    description="Set up directories for a distribution build">
    <ant:delete dir="${maven.dist.dir}"/>
    <ant:mkdir dir="${maven.dist.dir}"/>

    <j:choose>
      <j:when test="${avalon.snapshot}">
        <maven:snapshot project="${pom}"/>
        <j:set var="timestamp" value="${snapshotSignature.substring(18)}"/>
        <j:set var="binary.name" value="${maven.final.name}-${timestamp}-dist"/>
        <j:set var="source.name" value="${maven.final.name}-${timestamp}-src"/>
        <echo>Snapshot Packaging: ${timestamp}</echo>
      </j:when>
      <j:otherwise>
        <j:set var="binary.name" value="${maven.final.name}-dist"/>
        <j:set var="source.name" value="${maven.final.name}-src"/>
        <echo>Release Packaging: ${pom.currentVersion}</echo>
      </j:otherwise>
    </j:choose>

  </goal>

  <goal
    name="xdist:build-bin" 
    prereqs="xdist:prepare-bin-filesystem"
    description="Build the binary distribution.">

    <!-- Create a tar.gz file -->
    <ant:tar longfile="gnu" tarfile="${maven.dist.dir}/${binary.name}.tar">
      <ant:tarfileset dir="${maven.dist.bin.archive.dir}"/>
    </ant:tar>

    <ant:gzip 
      zipfile="${maven.dist.dir}/${binary.name}.tar.gz"
      src="${maven.dist.dir}/${binary.name}.tar"
    />
    <ant:delete file="${maven.dist.dir}/${binary.name}.tar"/>
    <checksum file="${maven.dist.dir}/${binary.name}.tar.gz"/>
    <ant:exec executable="${maven.gpg.exec}">
      <ant:arg value="--armour"/>
      <ant:arg value="-b"/>
      <ant:arg value="${maven.dist.dir}/${binary.name}.tar.gz"/>
    </ant:exec>

    <!-- Create a zip file -->
    <ant:zip zipfile="${maven.dist.dir}/${binary.name}.zip">
      <ant:zipfileset dir="${maven.dist.bin.archive.dir}"/>
    </ant:zip>
    <checksum file="${maven.dist.dir}/${binary.name}.zip"/>
    <ant:exec executable="${maven.gpg.exec}">
      <ant:arg value="--armour"/>
      <ant:arg value="-b"/>
      <ant:arg value="${maven.dist.dir}/${binary.name}.zip"/>
    </ant:exec>
  </goal>

  <goal
    name="xdist:build-src"
    prereqs="xdist:prepare-src-filesystem"
    description="Build the source distribution.">
 
    <!-- Create a tar.gz file -->
    <ant:tar longfile="gnu" tarfile="${maven.dist.dir}/${source.name}.tar">
      <ant:tarfileset dir="${maven.dist.src.archive.dir}"/>
    </ant:tar>
    <ant:gzip 
      zipfile="${maven.dist.dir}/${source.name}.tar.gz" 
      src="${maven.dist.dir}/${source.name}.tar"
    />
    <ant:delete file="${maven.dist.dir}/${source.name}.tar"/>
    <checksum file="${maven.dist.dir}/${source.name}.tar.gz"/>
    <ant:exec executable="${maven.gpg.exec}">
      <ant:arg value="--armour"/>
      <ant:arg value="-b"/>
      <ant:arg value="${maven.dist.dir}/${source.name}.tar.gz"/>
    </ant:exec>

    <!-- Create a zip file -->
    <ant:zip zipfile="${maven.dist.dir}/${source.name}.zip">
      <ant:zipfileset dir="${maven.dist.src.archive.dir}"/>
    </ant:zip>
    <checksum file="${maven.dist.dir}/${source.name}.zip"/>
    <ant:exec executable="${maven.gpg.exec}">
      <ant:arg value="--armour"/>
      <ant:arg value="-b"/>
      <ant:arg value="${maven.dist.dir}/${source.name}.zip"/>
    </ant:exec>
  </goal>

  <goal
    name="xdist:prepare-bin-filesystem" 
    description="Builds the binary files.">

    <ant:delete dir="${maven.dist.bin.assembly.dir}"/>
    <ant:mkdir dir="${maven.dist.bin.assembly.dir}"/>
    <ant:echo>
      +-------------------------------------------------------+
      | C R E A T I N G  B I N A R Y  D I S T R I B U T I O N |
      +-------------------------------------------------------+
    </ant:echo>
    <ant:copy todir="${maven.dist.bin.assembly.dir}">
      <ant:fileset dir=".">
        <ant:include name="LICENSE*"/>
        <ant:include name="README*"/>
      </ant:fileset>
    </ant:copy>

    <!-- Copy Jars -->
    <ant:copy todir="${maven.dist.bin.assembly.dir}/repository/avalon-repository">
      <ant:fileset dir="${maven.build.dir}">
        <ant:include name="jars/*.*"/>
      </ant:fileset>
    </ant:copy>

    <!-- Copy Docs -->
    <ant:copy todir="${maven.dist.bin.assembly.dir}">
      <ant:fileset dir="${maven.build.dir}">
        <ant:include name="docs/**"/>
      </ant:fileset>
    </ant:copy>

    <!-- Copy Bin -->
    <ant:copy todir="${maven.dist.bin.assembly.dir}/bin">
      <ant:fileset dir="${basedir}/cli/bin">
        <ant:include name="**"/>
      </ant:fileset>
      <filterset>
        <filter token="AVALON_CLI_VERSION" value="${avalon.cli.version}"/>
      </filterset>
    </ant:copy>

  </goal>

  <goal
    name="xdist:prepare-src-filesystem"
    description="Builds the source distribution file system.">
    <ant:delete dir="${maven.dist.src.assembly.dir}" />
    <ant:mkdir dir="${maven.dist.src.assembly.dir}" />

    <ant:echo>
      +-------------------------------------------------------+
      | C R E A T I N G  S O U R C E  D I S T R I B U T I O N |
      +-------------------------------------------------------+
    </ant:echo>

    <ant:copy todir="${maven.dist.src.assembly.dir}">
      <ant:fileset dir=".">
        <ant:include name="LICENSE*"/>
        <ant:include name="project.properties"/>
        <ant:include name="maven.xml"/>
        <ant:include name="project.xml"/>
      </ant:fileset>
    </ant:copy>

    <maven:reactor basedir="${basedir}"
      includes="**/project.xml"
      excludes="**/target/**,project.xml"
      banner="Building:"
      ignoreFailures="false"
      postProcessing="true" />
    <ant:copy todir="${maven.dist.src.assembly.dir}">
      <j:forEach var="child" items="${reactorProjects}">
        <ant:fileset dir="${child.file.parentFile}">
          <ant:exclude name="**/target/**"/>
          <ant:exclude name="**/*.log"/>
        </ant:fileset>
      </j:forEach>
    </ant:copy>

    <ant:copy todir="${maven.dist.src.assembly.dir}/site">
      <ant:fileset dir="site"/>
    </ant:copy>

  </goal>


  <goal name="xjavadoc">
    <ant:mkdir dir="${maven.build.dir}/docs/api" />
    <ant:property name="copyright"
      value="Copyright &amp;copy; ${year} ${pom.organization.name}. All Rights Reserved." />
    <ant:property name="title" value="${pom.name} ${pom.currentVersion}"/>
    <ant:javadoc destdir="${maven.build.dir}/docs/api" 
	doctitle="&lt;h1&gt;${title}&lt;/h1&gt;" 
      noindex="false" author="true" use="true"
	windowtitle="${title}" 
      bottom="${copyright}"
      additionalparam="-breakiterator -J-Xmx128m "
      packagenames="*,org.*">
        <j:forEach var="packageGroup" items="${pom.packageGroups}">
          <group title="${packageGroup.title}" packages="${packageGroup.packages}"/>
        </j:forEach>
        <sourcepath path="${basedir}/api/src/java"/>
        <sourcepath path="${basedir}/spi/src/java"/>
        <sourcepath path="${basedir}/impl/src/java"/>
        <sourcepath path="${basedir}/util/src/java"/>
        <sourcepath path="${basedir}/main/src/java"/>
        <classpath>
          <path refid="maven.dependency.classpath"/>
	  </classpath>
	  <link href="http://java.sun.com/j2se/1.4.2/docs/api/" />
    </ant:javadoc>
  </goal>

  <postGoal name="java:prepare-filesystem">
    <ant:available file="${maven.home}/plugins/${repo.plugin.jar}"
      property="repoPluginPresent"/>
    <j:if test="${repoPluginPresent != 'true'}">
      <ant:echo>
#####################################################################
#                                                                   #
#   WARNING:                                                        #
#   You do not have the required version of the avalon-repository   #
#   plugin installed on your system.                                #
#   Please invoke the following command                             #
#                                                                   #
#     $ maven avalon:setup                                          #
#                                                                   #
#####################################################################</ant:echo>
    </j:if>
  </postGoal>

</project>
