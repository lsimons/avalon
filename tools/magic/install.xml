<?xml version="1.0" encoding="UTF-8" ?>

<project name="install" default="setup" basedir=".">

  <property file="install.properties"/>

  <property environment="ENV"/>

  <condition property="magic.home.declared" value="false">
    <isset property="ENV.MAGIC_HOME"/>
  </condition>

  <target name="setup" 
      depends="check-magic-home,declare-magic-home,create-magic-home">
    <echo message="Setup complete."/>
  </target>

  <target name="declare-magic-home" if="magic.home.declared">
    <property name="magic.home" value="${ENV.MAGIC_HOME}"/>
  </target>

  <target name="check-magic-home" unless="magic.home.declared">
    <property name="magic.home" value="${user.home}/.magic"/>
  </target>

  <target name="create-magic-home" 
      depends="setup-proxy,setup-antlib" if="magic.home.declared">

    <echo message="Preparing magic system ..."/>
    <echo message="Using home directory: ${magic.home}"/>
    <mkdir dir="${magic.home}"/>

    <!-- Create the artifact cache. -->
    <property name="magic.home.main" value="${magic.home}/main"/>
    <mkdir dir="${magic.home.main}"/>

    <!-- Create the docs cache. -->
    <property name="magic.home.docs" value="${magic.home}/docs"/>
    <mkdir dir="${magic.home.docs}"/>

    <!-- Create the magic group cache dir. -->
    <property name="magic.bar.destination" 
      value="${magic.home.main}/${magic.bar.dir}"/>
    <mkdir dir="${magic.bar.destination}"/>

    <!-- Pull down the latest version of magic. -->
    <get src="${magic.bar.url}" usetimestamp="true"
      dest="${magic.bar.destination}/${magic.bar}"/>

    <!-- Unpack magic in the artifact cache. -->
    <property name="magic.bar.file" 
      value="${magic.bar.destination}/${magic.bar}"/>
    <unzip src="${magic.bar.file}" dest="${magic.bar.destination}">
      <patternset>
        <include name="**/*"/>
        <exclude name="META-INF/**"/>
        <exclude name="**/bars/**"/>
      </patternset>
    </unzip>

  </target>

  <condition property="magic.proxy.declared" value="false">
    <isset property="magic.proxy.host"/>
  </condition>

  <target name="setup-proxy" if="magic.proxy.declared">
     <setproxy 
         proxyhost="${magic.proxy.host}"
         proxyport="${magic.proxy.port}"
	   proxyuser="${magic.proxy.user}"
	   proxypassword="${magic.proxy.password}"/>
  </target>

  <available property="junit.available" classname="junit.framework.TestCase"/>

  <target name="setup-junit" depends="setup-antlib" unless="junit.available">
    <echo message="Resolving junit..."/>
    <get src="${junit.jar.url}" usetimestamp="true"
      dest="${ant.lib}/${junit.jar}"/>
  </target>

  <target name="populate-antlib" depends="setup-antlib">
    <echo message="Preparing supporting tools..."/>
    <copy toDir="${ant.lib}">
      <fileset dir="${cache.tools.dir}/jars">
        <include name="avalon-tools-*.jar"/>
      </fileset>
    </copy>
  </target>

  <target name="setup-antlib">
    <property name="ant.lib" value="${user.home}/.ant/lib"/>
    <mkdir dir="${ant.lib}"/>
  </target>

</project>
