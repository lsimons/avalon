
  

  
  

  
  

  

  
  

  
  

  
  

  

  

  

  

  

  
  
  
  
      
  

      
      
      
      
      
      
        
         
      
      

      
      
      
      

      
      
      

      

  
  

  
  

   
   


    
	
	

    
    
      
	
	
	<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

    <html>
      <head>
        
        
          <title>
            Merlin - 
          
        
          </title>
        
        
        
        <style type="text/css">
          @import url("../../style/tigris.css");
          @import url("../../style/maven.css");
        </style>
        
        
        
        
        
        <link rel="stylesheet" href="../../style/print.css" type="text/css" media="print"></link>
        <meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1"></meta>
        
        
        
        
      </head>

      <body class="composite">

        <div id="banner">
          <table height="103" border="0" width="100%" cellpadding="8" cellspacing="0">
            <tr>
              
              <td>
                
                
                  
                  
                  
                    
                  
                  
                  
                  
                  
                  <a href="http://avalon.apache.org/">
                    <img border="0" alt="Apache Software Foundation" src="http://avalon.apache.org/images/apache-avalon-logo.png" align="left"></img>
                  </a>
                
              </td>

              <td></td>
              

            </tr>
          </table>
        </div>
        <div id="breadcrumbs">
          <table border="0" width="100%" cellpadding="4" cellspacing="0">
            <tr>
              
              <td>
                <div align="right">
                  
                  
                  
                    
    
    
      
      
      
      <a href="http://apache.org/">Apache</a>
      
    
      |
      
      
      <a href="http://avalon.apache.org/">Avalon</a>
      
    
      |
      
      
      <a href="http://avalon.apache.org/product/framework/">Framework</a>
      
    
      |
      
      
      <a href="http://avalon.apache.org/product/containers/">Containers</a>
      
    
      |
      
      
      <a href="http://avalon.apache.org/product/components/">Components</a>
      
    
  
                  
                  
                </div>
              </td>
            </tr>
          </table>
        </div>
        
        <table border="0" width="100%" cellpadding="8" cellspacing="0"> 
          <tr valign="top">
            <td width="20%" id="leftcol">
              <div id="navcolumn">
                

                
                  
    <div>
      <strong>About Merlin</strong>
      
    
    
    
    

    <div>
      <small>
      	
      	
      		<a href="../../about/index.html">Overview</a>
      	
      </small>
	  
        
      
    </div>
  
    
    
    
    

    <div>
      <small>
      	
      	
      		<a href="../../starting/index.html">Getting Started</a>
      	
      </small>
	  
        
    
    
    
    

    <div>
      <small>
      	
      	
      		<a href="../../starting/installation/index.html">Installation</a>
      	
      </small>
	  
        
      
    </div>
  
    
    
    
    

    <div>
      <small>
      	
      	
      		<a href="../../starting/tutorial/index.html">Using Merlin</a>
      	
      </small>
	  
        
      
    </div>
  
    
    
    
    

    <div>
      <small>
      	
      	
      		<a href="../../starting/advanced/index.html">Advanced Features</a>
      	
      </small>
	  
        
    
    
    
    

    <div>
      <small>
      	
      	
      		<a href="../../starting/advanced/lifecycle/index.html">Lifecycle Extensions</a>
      	
      </small>
	  
        
      
    </div>
  
    
    
    
    

    <div>
      <small>
      	
      		<b><a href="../../starting/advanced/context.html">Contextualization</a></b>
      	
      	
      </small>
	  
        
      
    </div>
  
    
    
    
    

    <div>
      <small>
      	
      	
      		<a href="../../starting/advanced/profiles.html">Deployment Templates</a>
      	
      </small>
	  
        
      
    </div>
  
    
    
    
    

    <div>
      <small>
      	
      	
      		<a href="../../starting/advanced/selection.html">Profile Selection</a>
      	
      </small>
	  
        
      
    </div>
  
    
    
    
    

    <div>
      <small>
      	
      	
      		<a href="../../starting/advanced/composite.html">Composition</a>
      	
      </small>
	  
        
      
    </div>
  
    
    
    
    

    <div>
      <small>
      	
      	
      		<a href="../../starting/advanced/unit/index.html">Unit Test</a>
      	
      </small>
	  
        
      
    </div>
  
      
    </div>
  
      
    </div>
  
    
    
    
    

    <div>
      <small>
      	
      	
      		<a href="../../merlin/index.html">Merlin System</a>
      	
      </small>
	  
        
      
    </div>
  
    
    
    
    

    <div>
      <small>
      	
      	
      		<a href="../../meta/index.html">Meta Model</a>
      	
      </small>
	  
        
      
    </div>
  
    
    
    
    

    <div>
      <small>
      	
      	
      		<a href="../../tools/index.html">Tools</a>
      	
      </small>
	  
        
      
    </div>
  
    </div>
  
    <div>
      <strong>Resources</strong>
      
    
    
    
    

    <div>
      <small>
      	
      	
      		<a href="../../api/index.html">Javadoc</a>
      	
      </small>
	  
        
      
    </div>
  
    
    
    
    

    <div>
      <small>
      	
      	
      		<a href="../../resources/download.html">Download</a>
      	
      </small>
	  
        
      
    </div>
  
    
    
    
    

    <div>
      <small>
      	
      	
      		<a href="../../resources/roadmap/index.html">Roadmap</a>
      	
      </small>
	  
        
      
    </div>
  
    
    
    
    

    <div>
      <small>
      	
      	
      		<a href="../../dpml/index.html">DPML</a>
      	
      </small>
	  
        
      
    </div>
  
    </div>
  
    <div>
      <strong>Related Projects</strong>
      
    
    
    
    

    <div>
      <small>
      	
      	
      		<a href="http://avalon.apache.org/meta">Meta</a>
      	
      </small>
	  
        
      
    </div>
  
    
    
    
    

    <div>
      <small>
      	
      	
      		<a href="http://avalon.apache.org/util">Utilities</a>
      	
      </small>
	  
        
      
    </div>
  
    
    
    
    

    <div>
      <small>
      	
      	
      		<a href="http://avalon.apache.org/repository">Repository</a>
      	
      </small>
	  
        
      
    </div>
  
    </div>
  
                
                
                
                

                
                
                <div>
                  <strong>Project Documentation</strong>
                  
                  <div>
                    <small>
                      <a href="../../project-info.html">Project Info</a>
                    </small>
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                  </div>
                  <div>
                    <small>
                      <a href="../../maven-reports.html">Project Reports</a>
                    </small>
                    
					
                    
                    
                      
                      
                    
                      
                      
                    
                      
                      
                    
                    
                    
                    
                  </div>
                  
                  
                </div>
              
              
                
                
                
                
              
                
              </div>
            </td>
            <td rowspan="2">
              <div id="bodycol">
                
                <div class="app">
                  
                  
    <div class="h3">
      
      
        <h3>
          <a name="Advanced Features">Advanced Features</a>
        </h3>
      
      
    <div class="h4">
      
      
        <h4>
          <a name="Creating a custom Contextualizer">Creating a custom Contextualizer</a>
        </h4>
      
      
    <p>
      
         Merlin provides support for the pluggable introduction
         of contextualization stage handlers that are completely
         independent of the Avalon component model.
        
    </p>
   
    <p>
      
         Establishing a custom contextualizer involves:
        
    </p>
   
    <ul>
      
          
    <li>
      defining the contextualization interface
    </li>
   
          
    <li>
      implementation of a contextualization handler
    </li>
   
          
    <li>
      implementing the contextualization stage in a component
    </li>
   
        
    </ul>
   
    <p>
      
         Resources supporting this tutorial are included in the 
         tutorials/context/strategy package.
        
    </p>
   
    </div>
  
    <div class="h4">
      
      
        <h4>
          <a name="Contextualization stage definition">Contextualization stage definition</a>
        </h4>
      
      
    <p>
      
         You can declare any interface to serve as the contextualization
         lifecycle stage.  The following example follows the Avalon 
         pattern but passes a domain specific context as the contextualization
         argument (i.e. eliminating the need to cast to a domain specific
         interface).
        
    </p>
   
    <div id="source">
      <pre>
public interface Contextualizable
{
    /**
     * Contextualization of the component.
     * @param context the containment context
     * @exception ContextException if a contextualization error occurs
     */
    void contextualize( StandardContext context ) 
      throws ContextException;
}
</pre>
    </div>
  
    </div>
  
    <div class="h4">
      
      
        <h4>
          <a name="Contextualization handler implementation">Contextualization handler implementation</a>
        </h4>
      
      
    <p>
      
         A custom contextualization stage is managed by a contextualization
         handler component that you define.  The only constraint on a handler is 
         that it has to implement the org.apache.avalon.assembly.lifecycle.Contextualization
         interface.
        
    </p>
   
    <div id="source">
      <pre>
package tutorial;

import java.util.Map;
import org.apache.avalon.assembly.lifecycle.Contextualization;
import org.apache.avalon.framework.context.ContextException;
import org.apache.avalon.meta.model.ContextDirective;

public class ContextualizationHandler implements Contextualization
{
    /**
     * Handle the contextualization stage of a component lifecycle.
     * @param loader the classloader
     * @param directive the context directitive
     * @param object the object to contextualize
     * @param map the map of context entries
     * @exception ContextException if a contextualization error occurs
     */
    public void contextualize(
      ClassLoader loader, ContextDirective directive, Object object, Map map )
      throws ContextException
    {
        //
        // based on the supplied context directives, the container supplied 
        // map of base context entries and a classloader, build and apply
        // a context object to the supplied target object
        //

        if( object instanceof Contextualizable )
        {
            Object context = 
              createContextArgument( loader, directive, StandardContext.class, map );
            if( context instanceof StandardContext )
            {
                ( (Contextualizable)object ).contextualize( (StandardContext) context );
            }
            else
            {
                final String error =
                  "Supplied context does not implement the StandardContext interface.";
                throw new ContextException( error );
            }
        }
        else
        {
            final String error =
              "Target object does not implement the "
              + Contextualizable.class.getName() + " interface.";
            throw new ContextException( error );
        }
    }

   /**
    * Returns a instance of a class established using the supplied map as a
    * constructor argument.
    *
    * @param descriptor the context descriptor
    * @param clazz the default class if no class defined in the descriptor
    * @param map the context entry map
    * @return the context argument value
    */
    private Object createContextArgument( 
       ClassLoader loader, ContextDirective directive, Class clazz, Map map )
       throws ContextException
    {
        if( directive == null )
        {
            throw new NullPointerException( "directive" );
        }
        if( clazz == null )
        {
            throw new NullPointerException( "clazz" );
        }
        if( map == null )
        {
            throw new NullPointerException( "map" );
        }

        String classname = directive.getClassname();
        Class base;
        if( classname != null )
        {
            try
            {
                base = loader.loadClass( classname );
            }
            catch( ClassNotFoundException cnfe )
            {
                throw new ContextException(
                  "Could not find context class: " + classname, cnfe );
            }
        }
        else
        {
            base = clazz;
        }

        try
        {
            Constructor constructor = base.getConstructor(
               new Class[]{ Map.class } );
            return constructor.newInstance( new Object[]{ map } );
        }
        catch( NoSuchMethodException e )
        {
            final String error =
              "Custom context class: [" + classname
              + "] does not implement a constructor pattern &lt;init&gt;{ Map }.";
            throw new ContextException( error, e );
        }
        catch( Throwable e )
        {
            throw new ContextException(
                "Unexpected exception while creating context from "
                + base.getName(), e );
        }
    }
}
</pre>
    </div>
  
    </div>
  
    <div class="h4">
      
      
        <h4>
          <a name="Declaration of the handler">Declaration of the handler</a>
        </h4>
      
      
    <p>
      
          In order for the handler component to be recognized by 
          Merlin we need to declare a type definition.  The definition
          includes the declaration of the components support for 
          the custom contextualization interface under an extension
          declaration.
        
    </p>
   
    <div id="source">
      <pre>
&lt;type&gt;
  &lt;info&gt;
    &lt;name&gt;context&lt;/name&gt;
  &lt;/info&gt;
  &lt;extensions&gt;
    &lt;extension type="tutorial.Contextualizable" /&gt;
  &lt;/extensions&gt;
&lt;/type&gt;
</pre>
    </div>
  
    </div>
  
    <div class="h4">
      
      
        <h4>
          <a name="Create the component">Create the component</a>
        </h4>
      
      
    <p>
      
          With the stage interface defined and the handler implementation
          in place, we can go ahead and create a component that implements
          the new contextualization interface.
        
    </p>
   
    <div id="source">
      <pre>
public class StandardComponent 
    implements Contextualizable
{
    /**
     * Supply of the component context to the component type.
     * @param context the context value
     */
    public void contextualize( StandardContext context )
    {
        //
        // do some domain specific stuff using the supplied 
        // context 
        //
    }
}
</pre>
    </div>
  
    <p>
      
          Meta-info in the component context descriptor is required to declare to 
          Merlin that the component uses a custom context interface.  In the 
          following type descriptor the attribute key
          "urn:assembly:lifecycle.context.strategy" contains the classname of the
          interface used by the component for contextualization.
        
    </p>
   
    <div id="source">
      <pre>
&lt;type&gt;

  &lt;info&gt;
    &lt;name&gt;standard&lt;/name&gt;
  &lt;/info&gt;

  &lt;context&gt;
    &lt;attributes&gt;
      &lt;attribute key="urn:assembly:lifecycle.context.strategy"
          value="tutorial.Contextualizable"/&gt;
    &lt;/attributes&gt;
  &lt;/context&gt;

</pre>
    </div>
  
    </div>
  
    <div class="h4">
      
      
        <h4>
          <a name="Execution">Execution</a>
        </h4>
      
      
    <p>
      
          Execute the following commands to build and run the tutorial.
        
    </p>
   
    <div id="source">
      <pre>
$ ant jar
$ merlin tutorial.jar
</pre>
    </div>
  
    <p>
      
          Logging output from the tutorial execution is shown below:
        
    </p>
   
    <div id="source">
      <pre>
[INFO   ] (sys): initialization: localhost
[INFO   ] (sys): commencing block assembly phase
[INFO   ] (standard): context
  contextualization using a custom hander
  home: F:\dev\tutorial\contextualization\working\home\standard
  work: F:\dev\tutorial\contextualization\working\temp\standard
  name: standard
  partition: /standard

[INFO   ] (sys): Block hierarchy established.
</pre>
    </div>
  
    </div>
  
    </div>
  
                  
                  
                  
                  
                  
                </div>
              </div>
            </td>
          </tr>
        </table>
        <div id="footer">
          <table border="0" style="width:100%" cellpadding="4" cellspacing="0">
            
            <tr>
              <td>
                
                  
                    
                    
                      © 1997-2004, Apache Software Foundation
                    
                  
                  
                

                
              </td>
              
            </tr>
          </table>
        </div>
      </body>
    </html>
  